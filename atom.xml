<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Angus Su Blog</title>
  
  <subtitle>Angus Su Blog</subtitle>
  <link href="https://angus2292.github.io/atom.xml" rel="self"/>
  
  <link href="https://angus2292.github.io/"/>
  <updated>2025-02-13T17:19:26.508Z</updated>
  <id>https://angus2292.github.io/</id>
  
  <author>
    <name>Angus Su</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€æŠ€è¡“åˆ†äº«ã€‘Airflow å¿«é€Ÿå…¥é–€åŠå¦‚ä½•åœ¨ Docker ä¸Šå®‰è£</title>
    <link href="https://angus2292.github.io/title/"/>
    <id>https://angus2292.github.io/title/</id>
    <published>2023-09-17T16:00:00.000Z</published>
    <updated>2025-02-13T17:19:26.508Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»€éº¼æ˜¯-Airflowï¼Ÿ"><a href="#ä»€éº¼æ˜¯-Airflowï¼Ÿ" class="headerlink" title="ä»€éº¼æ˜¯ Airflowï¼Ÿ"></a>ä»€éº¼æ˜¯ Airflowï¼Ÿ</h1><p>å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»€éº¼æ˜¯ Airflowã€‚Airflow åŸå…ˆç”± Airbnb é–‹ç™¼çš„é–‹æºè»Ÿé«”ï¼Œç¾ç‚º Apache é ‚ç´šå°ˆæ¡ˆï¼Œä¸¦ä¸”å…·æœ‰ GUI ä»‹é¢ä¾›ä½¿ç”¨è€…ä½¿ç”¨ï¼Œæ˜¯ä»¥ Python å¯«æˆçš„å·¥ä½œæµç¨‹ç®¡ç†ç³»çµ±ï¼ˆWorkflow Management Systemï¼‰ã€‚</p><h3 id="ä½ å¯èƒ½æœƒå•ï¼ŒAirflow-å¯ä»¥æ‹¿ä¾†åšä»€éº¼ï¼Ÿ"><a href="#ä½ å¯èƒ½æœƒå•ï¼ŒAirflow-å¯ä»¥æ‹¿ä¾†åšä»€éº¼ï¼Ÿ" class="headerlink" title="ä½ å¯èƒ½æœƒå•ï¼ŒAirflow å¯ä»¥æ‹¿ä¾†åšä»€éº¼ï¼Ÿ"></a>ä½ å¯èƒ½æœƒå•ï¼ŒAirflow å¯ä»¥æ‹¿ä¾†åšä»€éº¼ï¼Ÿ</h3><p>è¿‘å¹´ä¾†ï¼Œä¸ç®¡æ˜¯è³‡æ–™ç§‘å­¸å®¶ã€è³‡æ–™å·¥ç¨‹å¸«ï¼Œé‚„æ˜¯ä»»ä½•éœ€è¦è™•ç†æ•¸æ“šçš„è»Ÿé«”å·¥ç¨‹å¸«ï¼ŒAirflow éƒ½æ˜¯ä»–å€‘ç”¨ä¾†å»ºæ§‹å¯é  ETL ä»¥åŠå®šæœŸè™•ç†æ‰¹é‡è³‡æ–™çš„é¦–é¸ä¹‹ä¸€ã€‚</p><h3 id="åœ¨ä½¿ç”¨-Airflow-ä¹‹å‰ä½ å¿…é ˆå…ˆäº†è§£â€¦"><a href="#åœ¨ä½¿ç”¨-Airflow-ä¹‹å‰ä½ å¿…é ˆå…ˆäº†è§£â€¦" class="headerlink" title="åœ¨ä½¿ç”¨ Airflow ä¹‹å‰ä½ å¿…é ˆå…ˆäº†è§£â€¦"></a>åœ¨ä½¿ç”¨ Airflow ä¹‹å‰ä½ å¿…é ˆå…ˆäº†è§£â€¦</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘å€‘æœƒå°‡ç›¸é—œçš„å·¥ä½œè¨­è¨ˆç‚ºä¸€å€‹ã€Œ<strong>æœ‰å‘ç„¡å¾ªç’°åœ–</strong>ã€(DAG, Directed Acyclic Graph)ï¼Œé¡§åæ€ç¾©å°±æ˜¯å…·æœ‰<strong>æ–¹å‘æ€§</strong>ä¸”<strong>ç„¡å›å‘</strong>çš„çµæ§‹ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ Airflow é€²è¡Œé–‹ç™¼æ™‚ï¼Œéœ€ç¢ºä¿å·¥ä½œä¹‹é–“çš„ç›¸ä¾æ€§ï¼ˆDependenciesï¼‰ï¼Œè®“ Airflow å¹«åŠ©æˆ‘å€‘ç®¡ç†å·¥ä½œæµç¨‹ã€‚</p><h3 id="Airflow-çš„å¥½è™•"><a href="#Airflow-çš„å¥½è™•" class="headerlink" title="Airflow çš„å¥½è™•"></a>Airflow çš„å¥½è™•</h3><ol><li><strong>å®šæœŸåŸ·è¡Œå·¥ä½œæµç¨‹</strong>ï¼Œè§£æ±ºè‡ªå‹•åŒ–çš„ç—›é»ã€‚</li><li><strong>ç¶­è­·ç›¸ä¾æ€§</strong>ï¼Œç¢ºä¿å·¥ä½œæµç¨‹å¾ä¸Šæ¸¸åˆ°ä¸‹æ¸¸åŸ·è¡Œï¼Œä¸æœƒåœ¨ä¸Šæ¸¸æœªå®Œæˆå‰åŸ·è¡Œä¸‹æ¸¸ã€‚</li><li><strong>è‡ªå‹•é‡è©¦æ©Ÿåˆ¶</strong>ï¼Œç¢ºä¿å³ä½¿ç™¼ç”Ÿæ„å¤–ï¼Œä»èƒ½é †åˆ©å®Œæˆå·¥ä½œã€‚</li><li><strong>ç›´è§€çš„ Web UI</strong>ï¼Œæ–¹ä¾¿ç®¡ç†èˆ‡ç›£æ§å·¥ä½œæµç¨‹ã€‚</li></ol><p>æ¥ä¸‹ä¾†å°±ä¾†æ•™å¤§å®¶å¦‚ä½•åœ¨ Docker ä¸Šå®‰è£ Airflow å§ï¼</p><hr><h1 id="åœ¨-Docker-ä¸Šå®‰è£-Airflow"><a href="#åœ¨-Docker-ä¸Šå®‰è£-Airflow" class="headerlink" title="åœ¨ Docker ä¸Šå®‰è£ Airflow"></a>åœ¨ Docker ä¸Šå®‰è£ Airflow</h1><h2 id="ç’°å¢ƒæº–å‚™"><a href="#ç’°å¢ƒæº–å‚™" class="headerlink" title="ç’°å¢ƒæº–å‚™"></a>ç’°å¢ƒæº–å‚™</h2><p>å»ºè­°ä½¿ç”¨ Linux ç³»çµ±ï¼Œä¾‹å¦‚ Ubuntu 20.04 LTSï¼Œä¹Ÿå¯ä½¿ç”¨ Windows çš„ Linux å­ç³»çµ±ã€‚æ­¤å¤–ï¼Œè«‹é å…ˆå®‰è£ï¼š</p><ol><li><strong>Docker</strong></li><li><strong>Docker Compose</strong></li></ol><p>ç•¶ç’°å¢ƒæº–å‚™å°±ç·’å¾Œï¼Œå³å¯é–‹å§‹å®‰è£ï¼</p><h2 id="å®‰è£æ–¹å¼"><a href="#å®‰è£æ–¹å¼" class="headerlink" title="å®‰è£æ–¹å¼"></a>å®‰è£æ–¹å¼</h2><p>æä¾›å…©ç¨®å®‰è£æ–¹å¼ï¼š</p><h3 id="æ–¹æ³•-1ï¼šä½¿ç”¨ç¾æˆçš„-Repository"><a href="#æ–¹æ³•-1ï¼šä½¿ç”¨ç¾æˆçš„-Repository" class="headerlink" title="æ–¹æ³• 1ï¼šä½¿ç”¨ç¾æˆçš„ Repository"></a>æ–¹æ³• 1ï¼šä½¿ç”¨ç¾æˆçš„ Repository</h3><ol><li>ä¸‹è¼‰å·²æº–å‚™å¥½çš„ <code>Dockerfile</code> åŠç¤ºç¯„ç¨‹å¼ç¢¼ï¼š<pre><code class="highlight sh">git <span class="built_in">clone</span> https://github.com/angus2292/Airflow_Quick_Start.git</code></pre></li><li>é€²å…¥ repo ç›®éŒ„ï¼ˆæ‡‰è©²èƒ½çœ‹åˆ° <code>Dockerfile</code>ï¼‰ï¼ŒåŸ·è¡Œï¼š<pre><code class="highlight sh">docker build -t airflow_demo:0.0.1 .</code></pre></li><li>å»ºç«‹å®Œæˆå¾Œï¼ŒåŸ·è¡Œï¼š<pre><code class="highlight sh">docker compose up -d</code></pre></li></ol><h3 id="æ–¹æ³•-2ï¼šåƒè€ƒå®˜æ–¹æ–‡ä»¶å®‰è£"><a href="#æ–¹æ³•-2ï¼šåƒè€ƒå®˜æ–¹æ–‡ä»¶å®‰è£" class="headerlink" title="æ–¹æ³• 2ï¼šåƒè€ƒå®˜æ–¹æ–‡ä»¶å®‰è£"></a>æ–¹æ³• 2ï¼šåƒè€ƒå®˜æ–¹æ–‡ä»¶å®‰è£</h3><ol><li>å»ºç«‹æ–°è³‡æ–™å¤¾ï¼Œä¸‹è¼‰æœ€æ–°ç‰ˆ <code>docker-compose.yaml</code>ï¼š<pre><code class="highlight sh">curl -LfO <span class="string">&#x27;https://airflow.apache.org/docs/apache-airflow/2.7.1/docker-compose.yaml&#x27;</span></code></pre></li><li>æ–°å¢ <code>dags</code>, <code>logs</code>, <code>plugins</code> åŠ <code>config</code> è³‡æ–™å¤¾ï¼Œä¸¦è¨­å®šä½¿ç”¨è€… IDï¼š<pre><code class="highlight sh"><span class="built_in">mkdir</span> -p ./dags ./logs ./plugins ./config<span class="built_in">echo</span> -e <span class="string">&quot;AIRFLOW_UID=<span class="subst">$(id -u)</span>&quot;</span> &gt; .<span class="built_in">env</span></code></pre><strong>æ³¨æ„</strong>ï¼šè‹¥åœ¨ Windows æˆ– macOS ä¸Šå‡ºç¾ <code>æ²’æœ‰è¨­ç½® AIRFLOW_UID</code>ï¼Œè«‹æ‰‹å‹•å»ºç«‹ <code>.env</code>ï¼Œä¸¦è¨­å®š <code>AIRFLOW_UID=50000</code>ã€‚</li><li>åŸ·è¡Œ Docker Composeï¼š<pre><code class="highlight sh">docker compose up -d</code></pre></li></ol><p>é€™æ¨£å°±å®Œæˆ Airflow çš„å®‰è£å›‰ï¼è¶•å¿«æ‰“é–‹ <code>localhost:8080</code>ï¼Œä½¿ç”¨é è¨­å¸³è™Ÿå¯†ç¢¼ <code>airflow/airflow</code> ç™»å…¥å§ï¼</p><hr><h1 id="å¦‚ä½•ç”¨-Python-æ’°å¯«-DAGï¼Ÿ"><a href="#å¦‚ä½•ç”¨-Python-æ’°å¯«-DAGï¼Ÿ" class="headerlink" title="å¦‚ä½•ç”¨ Python æ’°å¯« DAGï¼Ÿ"></a>å¦‚ä½•ç”¨ Python æ’°å¯« DAGï¼Ÿ</h1><h2 id="DAG-èˆ‡-Task"><a href="#DAG-èˆ‡-Task" class="headerlink" title="DAG èˆ‡ Task"></a>DAG èˆ‡ Task</h2><p>ä¸€å€‹ DAG æ˜¯ç”±å¤šå€‹ Tasks çµ„æˆï¼Œæ¯å€‹ Task çš†ç¨ç«‹åŸ·è¡Œã€‚Task ç”± <strong>Operator</strong> å®šç¾©ï¼Œå¸¸è¦‹çš„æœ‰ï¼š</p><ul><li><strong>SimpleHttpOperator</strong>ï¼šç”¨æ–¼åŸ·è¡Œ HTTP è«‹æ±‚ï¼Œå¦‚ API å‘¼å«ã€‚</li><li><strong>PythonOperator</strong>ï¼šåŸ·è¡Œè‡ªè¨‚çš„ Python å‡½æ•¸ã€‚</li><li><strong>PostgresOperator</strong>ï¼šåŸ·è¡Œ PostgreSQL æŸ¥è©¢æˆ–æ•¸æ“šåº«æ“ä½œã€‚</li></ul><h3 id="PythonOperator-ç¯„ä¾‹"><a href="#PythonOperator-ç¯„ä¾‹" class="headerlink" title="PythonOperator ç¯„ä¾‹"></a>PythonOperator ç¯„ä¾‹</h3><pre><code class="highlight python"><span class="keyword">from</span> airflow <span class="keyword">import</span> DAG<span class="keyword">from</span> airflow.operators.python <span class="keyword">import</span> PythonOperator<span class="keyword">from</span> airflow.utils.dates <span class="keyword">import</span> days_ago<span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta<span class="keyword">def</span> <span class="title function_">task1</span>():    <span class="built_in">print</span>(<span class="string">&#x27;task 1&#x27;</span>)<span class="keyword">def</span> <span class="title function_">task2</span>():    <span class="built_in">print</span>(<span class="string">&#x27;task 2&#x27;</span>)default_args = &#123;    <span class="string">&#x27;owner&#x27;</span>: <span class="string">&#x27;Angus Su&#x27;</span>,    <span class="string">&#x27;start_date&#x27;</span>: days_ago(<span class="number">1</span>),    <span class="string">&quot;retries&quot;</span>: <span class="number">1</span>,    <span class="string">&quot;retry_delay&quot;</span>: timedelta(minutes=<span class="number">5</span>)&#125;<span class="keyword">with</span> DAG(<span class="string">&#x27;example_dag&#x27;</span>, default_args=default_args) <span class="keyword">as</span> dag:    t1 = PythonOperator(        task_id=<span class="string">&#x27;task_1&#x27;</span>,        python_callable=task1    )        t2 = PythonOperator(        task_id=<span class="string">&#x27;task_2&#x27;</span>,        python_callable=task2    )        t1 &gt;&gt; t2  <span class="comment"># è¨­å®š Task åŸ·è¡Œé †åº</span></code></pre><hr><h1 id="TaskFlow-API"><a href="#TaskFlow-API" class="headerlink" title="TaskFlow API"></a>TaskFlow API</h1><h2 id="ä»€éº¼æ˜¯-TaskFlowï¼Ÿ"><a href="#ä»€éº¼æ˜¯-TaskFlowï¼Ÿ" class="headerlink" title="ä»€éº¼æ˜¯ TaskFlowï¼Ÿ"></a>ä»€éº¼æ˜¯ TaskFlowï¼Ÿ</h2><p>Airflow 2.0 å¼•å…¥äº† <strong>TaskFlow API</strong>ï¼Œè®“ DAG ä¾è³´ç®¡ç†æ›´ç›´è¦ºï¼Œä¸¦å…§å»º XCom è³‡æ–™å‚³éæ©Ÿåˆ¶ã€‚</p><h3 id="ä»¥å¾€-XCom-è³‡æ–™å‚³éæ–¹å¼"><a href="#ä»¥å¾€-XCom-è³‡æ–™å‚³éæ–¹å¼" class="headerlink" title="ä»¥å¾€ XCom è³‡æ–™å‚³éæ–¹å¼"></a>ä»¥å¾€ XCom è³‡æ–™å‚³éæ–¹å¼</h3><pre><code class="highlight python"><span class="keyword">def</span> <span class="title function_">ProcessData</span>(<span class="params">**kwargs</span>):    result = get_result()    push_result_to_xcom(result)<span class="keyword">def</span> <span class="title function_">LoadData</span>(<span class="params">**kwargs</span>):    data = get_data_from_xcom()</code></pre><h3 id="TaskFlow-API-æ”¹å¯«ç‰ˆ"><a href="#TaskFlow-API-æ”¹å¯«ç‰ˆ" class="headerlink" title="TaskFlow API æ”¹å¯«ç‰ˆ"></a>TaskFlow API æ”¹å¯«ç‰ˆ</h3><pre><code class="highlight python"><span class="keyword">from</span> airflow.decorators <span class="keyword">import</span> task<span class="keyword">def</span> <span class="title function_">example_task_flow</span>():    <span class="meta">    @task</span>    <span class="keyword">def</span> <span class="title function_">ProcessData</span>():        result = get_result()        <span class="keyword">return</span> result<span class="meta">    @task</span>    <span class="keyword">def</span> <span class="title function_">LoadData</span>(<span class="params">result</span>):        data = process(result)        <span class="keyword">return</span> data        res = ProcessData()    LoadData(res)example_task_flow()</code></pre><h3 id="TaskFlow-API-å„ªå‹¢"><a href="#TaskFlow-API-å„ªå‹¢" class="headerlink" title="TaskFlow API å„ªå‹¢"></a>TaskFlow API å„ªå‹¢</h3><ul><li>é€é <code>@task</code> ç°¡åŒ– PythonOperator çš„å¯«æ³•ã€‚</li><li>è‡ªå‹•è™•ç† XCom è³‡æ–™å‚³éï¼Œç„¡éœ€æ‰‹å‹• <code>push</code>&#x2F;<code>pull</code>ã€‚</li><li>è®“ç¨‹å¼ç¢¼æ›´ç›´è§€ã€æ˜“è®€ã€‚</li></ul><hr><h1 id="ç¸½çµ"><a href="#ç¸½çµ" class="headerlink" title="ç¸½çµ"></a>ç¸½çµ</h1><p>æœ¬æ–‡ç°¡è¦ä»‹ç´¹äº†ï¼š</p><ul><li><strong>Airflow çš„åŸºæœ¬æ¦‚å¿µ</strong></li><li><strong>å¦‚ä½•åœ¨ Docker ä¸Šå®‰è£ Airflow</strong></li><li><strong>å¦‚ä½•æ’°å¯« DAG</strong></li><li><strong>TaskFlow API çš„ä½¿ç”¨</strong></li></ul><p>Airflow æ˜¯ä¸€å€‹å¼·å¤§çš„å·¥ä½œæµç¨‹è‡ªå‹•åŒ–å·¥å…·ï¼Œå¸Œæœ›é€™ç¯‡æ–‡ç« å°ä½ æœ‰æ‰€å¹«åŠ©ï¼</p><p>æ­¤å¤–ï¼Œæˆ‘æº–å‚™äº†ä¸€å€‹ <strong>PTT è‚¡ç¥¨çˆ¬èŸ²æ¡ˆä¾‹</strong>ï¼Œå¯åœ¨ <code>dags</code> ç›®éŒ„ä¸­æ‰¾åˆ°ï¼š</p><pre><code class="highlight sh">git <span class="built_in">clone</span> https://github.com/angus2292/Airflow_Quick_Start.git</code></pre><p>å…§å« <code>crawling.py</code> èˆ‡ <code>crawling_task_flow.py</code>ï¼Œç¤ºç¯„ TaskFlow API çš„æ‡‰ç”¨ã€‚</p><p>æ„Ÿè¬é–±è®€ï¼ğŸ‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä»€éº¼æ˜¯-Airflowï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä»€éº¼æ˜¯-Airflowï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä»€éº¼æ˜¯ Airflowï¼Ÿ&quot;&gt;&lt;/a&gt;ä»€éº¼æ˜¯ Airflowï¼Ÿ&lt;/h1&gt;&lt;p&gt;å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»€éº¼æ˜¯ Airflowã€‚Airflow åŸå…ˆç”±</summary>
      
    
    
    
    
    <category term="docker" scheme="https://angus2292.github.io/tags/docker/"/>
    
    <category term="airflow" scheme="https://angus2292.github.io/tags/airflow/"/>
    
  </entry>
  
</feed>
